<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>デカブサ占い</title>

<style>
:root{
  --bg:#f7f7f7;
  --card:#ffffff;
  --line:#e6e6e6;
  --text:#111;
  --muted:#666;
  --accent:#ffd400;

  --footer-h: 140px;
  --deka-w: 260px;
  --deka-gap: 14px;
  --text-top-pad: 26px;
}

*{ box-sizing:border-box; }

body{
  margin:0;
  font-family: system-ui, -apple-system, "Hiragino Kaku Gothic ProN",
               "Noto Sans JP", "Yu Gothic", sans-serif;
  background: var(--bg);
  color: var(--text);
}

.wrap{
  min-height: 100svh;
  display:flex;
  align-items:center;
  justify-content:center;
  padding: 18px;
}

.card{
  width: min(680px, 100%);
  background: var(--card);
  border: 1px solid var(--line);
  border-radius: 14px;
  overflow:hidden;
  position: relative;
}

header{
  padding: 14px 16px;
  border-bottom: 1px solid var(--line);
  display:flex;
  align-items:center;
  justify-content: space-between;
  gap:10px;
}

.headLeft{
  display:flex;
  align-items:center;
  gap:10px;
  min-width: 0;
}

.dot{
  width:10px; height:10px;
  border-radius:50%;
  background: var(--accent);
  flex: 0 0 auto;
}

h1{
  font-size:14px;
  font-weight:700;
  margin:0;
  letter-spacing:.08em;
  color:var(--muted);
  white-space: nowrap;
}

#quota{
  font-size: 12px;
  color: #9a9a9a;
  letter-spacing: .08em;
  white-space: nowrap;
}

main{
  padding: var(--text-top-pad) 18px calc(var(--footer-h) + 18px);
  text-align:center;
  min-height: 520px;
  position: relative;
}

#text{
  white-space: pre-line;
  font-size: clamp(28px, 4.6vw, 36px);
  line-height: 1.55;
  letter-spacing: .06em;
  margin: 0;
  text-align: center;
}

#sub{
  margin: 20px 0 0;
  font-size: 14px;
  color: #9a9a9a;
  letter-spacing: .08em;
  min-height: 1.6em;
  white-space: nowrap;
  text-align: center;
  line-height: 1.9;
}

/* 点滅（タップ誘導） */
.blink{
  animation: blinkFade 1.2s ease-in-out infinite;
}
@keyframes blinkFade{
  0%,100%{ opacity: 0.25; }
  50%    { opacity: 1; }
}

footer{
  border-top: 1px solid var(--line);
  height: var(--footer-h);
  display:grid;
  grid-template-columns: 1fr 1fr;
  gap:12px;
  justify-content:center;
  align-items:center;
  padding: 14px;
}

button{
  appearance:none;
  border:1px solid var(--line);
  background:#fafafa;
  color:#111;
  border-radius: 18px;
  padding:16px 10px;
  font-size:16px;
  cursor:pointer;
  transition: opacity .15s ease;
}

button:active{
  transform: translateY(1px);
  background:#f2f2f2;
}

footer.locked button{
  opacity: .35;
  cursor: default;
  pointer-events: none;
}

.character{
  position:absolute;
  right: var(--deka-gap);
  bottom: var(--footer-h);
  width: var(--deka-w);
  height: auto;
  opacity: .98;
  pointer-events:none;
  user-select:none;
  transform-origin: 70% 85%;
}

/* 軽い演出：ナマケン/カンえもん */
.char-pop{
  animation: pop 260ms ease-out;
}
@keyframes pop{
  0%   { transform: scale(1); }
  60%  { transform: scale(1.06); }
  100% { transform: scale(1); }
}
.char-wobble{
  animation: wobble 520ms ease-in-out;
}
@keyframes wobble{
  0%   { transform: rotate(0deg) translateY(0px); }
  25%  { transform: rotate(-1.8deg) translateY(-1px); }
  50%  { transform: rotate( 1.8deg) translateY(0px); }
  75%  { transform: rotate(-1.0deg) translateY(1px); }
  100% { transform: rotate(0deg) translateY(0px); }
}

/* ライオン丸用：軽い暗転 */
.dim{
  position:absolute;
  inset:0;
  background: rgba(0,0,0,0.22);
  opacity:0;
  pointer-events:none;
  transition: opacity .2s ease;
}
.dim.show{ opacity:1; }
</style>
</head>

<body>
<div class="wrap">
  <div class="card">
    <header>
      <div class="headLeft">
        <div class="dot"></div>
        <h1>デカブサ占い</h1>
      </div>
      <div id="quota"></div>
    </header>

    <main id="main">
      <p id="text">読み込み中</p>
      <p id="sub"></p>
    </main>

    <footer id="choices" class="locked"></footer>

    <img id="charaImg" class="character" src="dekabusa.png" alt="character">
    <div id="dim" class="dim"></div>

    <audio id="clap" src="clap.mp3" preload="auto"></audio>
  </div>
</div>

<script>
/* =====================
   デバッグ（?debug=1）
===================== */
const params = new URLSearchParams(location.search);
const IS_DEBUG = params.get("debug") === "1";

/* =====================
   回数制限（1日3回）
   ※debug=1 は無制限
===================== */
const DAILY_LIMIT = 3;
const KEY_DATE="dekabusa_date";
const KEY_COUNT="dekabusa_count";

function todayKey(){
  return new Date().toLocaleDateString("ja-JP");
}
function loadCount(){
  const t = todayKey();
  const d = localStorage.getItem(KEY_DATE);
  if(d !== t){
    localStorage.setItem(KEY_DATE, t);
    localStorage.setItem(KEY_COUNT, "0");
  }
  const c = parseInt(localStorage.getItem(KEY_COUNT) || "0", 10);
  return isNaN(c) ? 0 : c;
}
function remainCount(){
  if(IS_DEBUG) return DAILY_LIMIT; // 表示は通常のまま
  const c = loadCount();
  return Math.max(0, DAILY_LIMIT - Math.min(c, DAILY_LIMIT));
}
function consumeOnce(){
  if(IS_DEBUG) return true; // デバッグは消費しない
  const c = loadCount();
  if(c >= DAILY_LIMIT) return false;
  localStorage.setItem(KEY_COUNT, String(c + 1));
  return true;
}
function updateQuota(){
  const r = remainCount();
  quota.textContent = (r <= 0) ? "今日はもう終わりです" : `今日はあと${r}回`;
}

/* =====================
   イントロ（数字は固定）
   出現率だけ 5% / 95%
===================== */
function pickIntro(){
  const rare = Math.random() < 0.05; // ちょい出やすく（5%）
  return rare
    ? "あなたの運勢はどう？\n\n2%の人が\n当たったと解答"
    : "あなたの運勢はどう？\n\n98%の人が\n外れたと解答";
}

/* =====================
   7問（デカブサ世界っぽく）
===================== */
const QUESTIONS = [
  { q:"朝。\n最初にすることは？", a:["とりあえず起きる","起きた体にする","まだ夜の続き","今じゃない"] },
  { q:"やることが増えた。\nどうする？", a:["一個だけやる","検討はした","永久に保留","見なかった"] },
  { q:"予定に誘われた。\n返事は？", a:["行けたら行く","あとで返す","既読のまま","気配を消す"] },
  { q:"財布が軽い。\n気分は？", a:["節約する","気にしない","見ない","増えない"] },
  { q:"作業が重い。\n手は動く？", a:["動く","半分だけ動く","動かない","やってる感"] },
  { q:"外がうるさい。\n対処は？", a:["耐える","耳栓","逃げる","心を無にする"] },
  { q:"最後に。\n今日の方針は？", a:["無理しない","普通","無","今日はそういう日"] },
];

/* スコア（雑でOK）：左ほど“動く”、右ほど“動かない” */
const SCORE = [
  [2,1,0,0],
  [2,1,0,0],
  [2,1,0,0],
  [1,1,0,0],
  [2,1,0,0],
  [1,1,0,0],
  [0,0,0,0],
];

/* =====================
   キャラ（居座り仕様）
   - ナマケン/カンえもん：次の回答まで居座る
   - ライオン丸：特別演出後「タップで進む」→ 進む時にデカブサへ戻る
   - 結果画面：必ずデカブサ
===================== */
const CHAR = {
  dekabusa: { img:"dekabusa.png", say:["まあ、そうだな","無理すんな","続けよう","今はそれでいい","だいたいそんなもんだ"] },
  namaken:  { img:"namaken.png",  say:["あとでいい","急ぐな","寝てもいい","そのうち","まあ…"] },
  kanemon:  { img:"kanemon.png",  say:["まあ入る","持っとくか","使わないかも","入れとく","とりあえず"] },
  lion:     { img:"lionmaru.png", special:true },
};

/* 出現率：デカ75 / ナマ10 / カン10 / ライオン5 */
function pickSpeaker(){
  const r = Math.random() * 100;
  if(r < 75) return "dekabusa";
  if(r < 85) return "namaken";
  if(r < 95) return "kanemon";
  return "lion";
}

/* =====================
   DOM
===================== */
const mainEl = document.getElementById("main");
const text = document.getElementById("text");
const sub  = document.getElementById("sub");
const footer = document.getElementById("choices");
const quota = document.getElementById("quota");
const charaImg = document.getElementById("charaImg");
const dim = document.getElementById("dim");
const clap = document.getElementById("clap");

/* =====================
   進行状態
===================== */
let mode = "intro"; // intro | q | result | limit | lion_wait
let idx = -1;
let score = 0;

let currentChar = "dekabusa";
function setChar(name){
  currentChar = name;
  charaImg.src = CHAR[name].img;
}
function lockChoices(locked){
  if(locked) footer.classList.add("locked");
  else footer.classList.remove("locked");
}
function clearCharFx(){
  charaImg.classList.remove("char-pop","char-wobble");
}
function applyCharFx(kind){
  clearCharFx();
  // reflowでアニメ再発火
  void charaImg.offsetWidth;
  if(kind) charaImg.classList.add(kind);
}

/* =====================
   表示関数
===================== */
function showLimit(){
  mode = "limit";
  lockChoices(true);
  setChar("dekabusa");
  dim.classList.remove("show");
  text.textContent = "今日は\nもうこれくらいです\n\nまた明日";
  sub.classList.remove("blink");
  sub.textContent = "";
  updateQuota();
}

function showIntro(){
  updateQuota();
  if(!IS_DEBUG && remainCount() <= 0){
    showLimit();
    return;
  }
  mode = "intro";
  idx = -1;
  score = 0;
  setChar("dekabusa");
  dim.classList.remove("show");

  text.textContent = pickIntro();
  sub.classList.add("blink");
  sub.textContent = "タップして";
  footer.innerHTML = "";
  lockChoices(true);
}

function renderQuestion(){
  mode = "q";
  dim.classList.remove("show");

  const q = QUESTIONS[idx];
  text.textContent = q.q;
  sub.classList.remove("blink");
  sub.textContent = `${idx+1} / ${QUESTIONS.length}`;

  footer.innerHTML = "";
  lockChoices(false);

  q.a.forEach((label, optIndex) => {
    const b = document.createElement("button");
    b.type = "button";
    b.textContent = label;
    b.onclick = () => onAnswer(optIndex);
    footer.appendChild(b);
  });
}

function nextQuestion(){
  idx++;
  if(idx >= QUESTIONS.length){
    showResult();
    return;
  }
  // 次の問題は「今居るキャラのまま」表示される（居座り仕様）
  renderQuestion();
}

/* 回答後のキャラ台詞（居座り） */
function showSpeakerLine(charName){
  if(charName === "lion"){
    // ライオン丸：特別演出 → 自動で進まない（タップで進む）
    mode = "lion_wait";
    setChar("lion");
    lockChoices(true);

    dim.classList.add("show");
    text.textContent = "ザ・トーマレ！";
    sub.classList.remove("blink");
    sub.textContent = "";

    setTimeout(() => {
      text.textContent = "ザ・トーマレ！\n時を止めてから拍手";
      // 拍手SE（無くても落ちない）
      try{
        const p = clap.play();
        if(p && typeof p.catch === "function") p.catch(()=>{});
      }catch(e){}
      // ここで進行を止める：タップ待ち
      sub.classList.add("blink");
      sub.textContent = "タップして続ける";
    }, 400);

    return;
  }

  // 通常キャラ：軽い演出＋一言 → 少し待って次へ（キャラはそのまま居座る）
  setChar(charName);
  lockChoices(true);

  // 演出（ナマケン/カンえもんは少し目立たせる）
  if(charName === "namaken") applyCharFx("char-wobble");
  else if(charName === "kanemon") applyCharFx("char-pop");
  else clearCharFx();

  const lines = CHAR[charName].say;
  const line = lines[Math.floor(Math.random() * lines.length)];
  text.textContent = line;
  sub.classList.remove("blink");
  sub.textContent = "";

  setTimeout(() => {
    nextQuestion();
  }, 700);
}

function onAnswer(optIndex){
  // スコア加算（適当）
  if(SCORE[idx] && typeof SCORE[idx][optIndex] === "number"){
    score += SCORE[idx][optIndex];
  }

  // 次の“発言者”を抽選して喋らせる
  const speaker = pickSpeaker();
  showSpeakerLine(speaker);
}

function showResult(){
  // 結果表示時に回数消費（debugは消費しない）
  if(!consumeOnce()){
    showLimit();
    return;
  }
  updateQuota();

  mode = "result";
  lockChoices(true);

  // 結果画面は必ずデカブサ
  setChar("dekabusa");
  clearCharFx();
  dim.classList.remove("show");

  let result;
  if(score >= 9) result = "今日は\n割と動ける\n\nでも無理はするな";
  else if(score >= 5) result = "今日は\n普通\n\nだいたい普通";
  else result = "今日は\n無\n\nやらなくていい";

  text.textContent = result;
  sub.classList.remove("blink");
  sub.textContent = "今日は、そういう日だ";
}

/* =====================
   操作：タップ進行
===================== */
mainEl.addEventListener("click", () => {
  // intro → start
  if(mode === "intro"){
    if(!IS_DEBUG && remainCount() <= 0){
      showLimit();
      return;
    }
    sub.classList.remove("blink");
    nextQuestion();
    return;
  }

  // ライオン丸：ここでだけ「タップで続ける」
  if(mode === "lion_wait"){
    // 暗転解除し、デカブサへ戻して次へ
    dim.classList.remove("show");
    sub.classList.remove("blink");
    sub.textContent = "";

    setChar("dekabusa"); // ライオン丸は居座らない
    clearCharFx();
    nextQuestion();
    return;
  }
});

/* =====================
   起動
===================== */
updateQuota();
showIntro();
</script>
</body>
</html>
