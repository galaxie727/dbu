<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>デカブサ占い</title>
  <style>
    :root{
      --bg:#f7f7f7;
      --card:#ffffff;
      --line:#e6e6e6;
      --text:#111;
      --muted:#666;
      --muted2:#9a9a9a;
      --accent:#ffd400;

      --maxw:520px;
      --footerPad: 14px;
      --btnH: 58px;
      --safeB: env(safe-area-inset-bottom, 0px);
      --safeT: env(safe-area-inset-top, 0px);
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, "Hiragino Kaku Gothic ProN","Noto Sans JP","Yu Gothic", sans-serif;
      background: var(--bg);
      color: var(--text);
    }
    .wrap{
      min-height: 100svh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 18px;
    }
    .card{
      width: min(var(--maxw), 100%);
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 14px;
      overflow:hidden;
      position: relative;
    }
    header{
      padding: 14px 16px;
      border-bottom: 1px solid var(--line);
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap:10px;
    }
    .headLeft{
      display:flex;
      align-items:center;
      gap:10px;
      min-width:0;
    }
    .dot{
      width:10px; height:10px;
      border-radius:50%;
      background: var(--accent);
      flex:0 0 auto;
    }
    h1{
      font-size:14px;
      font-weight:700;
      margin:0;
      letter-spacing:.08em;
      color:var(--muted);
      white-space: nowrap;
    }
    #quota{
      font-size: 12px;
      color: var(--muted2);
      letter-spacing: .08em;
      white-space: nowrap;
      user-select:none;
    }

    main{
      padding: 18px;
      min-height: 620px;
    }

    /* ====== TOP ====== */
    .top{
      text-align:center;
      padding: 22px 10px 26px;
    }
    .topTitle{
      margin-top: 6px;
      font-size: clamp(20px, 5.8vw, 30px);
      font-weight: 700;
      letter-spacing:.06em;
      line-height:1.45;
    }
    .topCopy{
      margin-top: 18px;
      font-size: clamp(26px, 7.2vw, 40px);
      font-weight: 800;
      letter-spacing:.06em;
      line-height:1.25;
      white-space: pre-line;
    }
    .tapHint{
      margin: 18px 0 0;
      font-size: 13px;
      color: rgba(0,0,0,0.22);
      letter-spacing: .14em;
      user-select:none;
      animation: hintBlink 1.25s ease-in-out infinite;
    }
    @keyframes hintBlink{
      0%,100%{ opacity: .20; }
      50%    { opacity: .90; }
    }
    .hero{
      margin: 28px auto 0;
      width: min(260px, 70%);
      display:flex;
      justify-content:center;
      align-items:flex-end;
    }
    #topImg{
      width: 100%;
      height:auto;
      display:block;
      transform-origin: 50% 100%;
      animation: bob 3.6s ease-in-out infinite;
      will-change: transform;
    }
    @keyframes bob{
      0%,100%{ transform: translateY(0px) rotate(-0.2deg); }
      50%    { transform: translateY(-6px) rotate(0.2deg); }
    }
    .miniNote{
      margin-top: 14px;
      font-size: 12px;
      color: rgba(0,0,0,0.34);
      letter-spacing: .06em;
      line-height: 1.7;
    }

    /* ====== 共通ボタン ====== */
    .footer{
      border-top: 1px solid var(--line);
      padding: 14px 12px calc(14px + var(--safeB));
      background:#fff;
    }
    button{
      appearance:none;
      border:1px solid rgba(0,0,0,0.08);
      background:#fafafa;
      color:#111;
      border-radius: 18px;
      padding: 14px 18px;
      font-size:18px;
      cursor:pointer;
      transition: transform .12s ease, opacity .12s ease;
      min-height: var(--btnH);
    }
    button:active{
      transform: translateY(1px) scale(0.99);
      background:#f2f2f2;
    }
    .primary{
      border:none;
      background:#111;
      color:#fff;
      border-radius: 28px;
      letter-spacing:.12em;
      width: min(320px, 92%);
      margin: 0 auto;
      display:block;
    }
    .locked button{
      opacity:.35;
      pointer-events:none;
      cursor: default;
    }

    /* ====== GAME LAYOUT（キャラは下だけ） ====== */
    .game{
      display:flex;
      flex-direction:column;
      min-height: 620px;
      text-align:center;
    }
    #progress{
      font-size: 12px;
      color: var(--muted2);
      letter-spacing:.14em;
      margin: 6px 0 0;
      user-select:none;
    }
    #question{
      margin: 22px 0 0;
      font-size: clamp(20px, 6.0vw, 30px);
      line-height: 1.45;
      letter-spacing: .06em;
      white-space: pre-line;
      min-height: 3.2em;
    }
    .spacer{
      flex: 1 1 auto;   /* ここが“上の空き”を吸収してくれる */
      min-height: 18px;
    }

    /* キャラ（下固定） */
    .charBottom{
      display:flex;
      justify-content:center;
      align-items:flex-end;
      padding: 6px 0 8px;
    }
    #charImg{
      width: 240px;
      height:auto;
      user-select:none;
      pointer-events:none;
      transition: opacity 0.15s;
    }

    /* 選択肢（4択） */
    .answers{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      padding: 0 6px 6px;
    }
    .answers button{
      width: 100%;
      font-size: 18px;
      border-radius: 18px;
      background:#fff;
      border:1px solid rgba(0,0,0,0.10);
      min-height: 64px;
    }

    /* ====== 結果 ====== */
    .result{
      display:flex;
      flex-direction:column;
      min-height: 620px;
      text-align:center;
      padding: 6px 0 0;
    }
    .resultHead{
      padding-top: 12px;
    }
    .resultTitle{
      font-size:22px;
      margin: 0;
      letter-spacing:.04em;
    }
    .resultSub{
      margin-top: 18px;
      font-size:26px;
      line-height:1.5;
      letter-spacing:.04em;
    }
    #percentBig{
      margin-top: 24px;
      font-size: 72px;
      font-weight: 800;
      letter-spacing: .04em;
      line-height: 1;
    }
    #rankText{
      margin-top: 10px;
      font-size: 20px;
      font-weight: 800;
      letter-spacing:.08em;
    }
    #resultLines{
      margin-top: 14px;
      white-space: pre-line;
      font-size: 16px;
      line-height: 1.9;
      color:#111;
      padding: 0 12px;
    }
    .retryWrap{
      padding: 18px 0 8px;
    }
    .retryBtn{
      width: min(320px, 92%);
      border:none;
      background:#333;
      color:#fff;
      border-radius: 14px;
      font-size: 18px;
      min-height: 56px;
    }

    /* ====== 仲間紹介モーダル ====== */
    .modalBack{
      position: fixed;
      inset:0;
      background: rgba(0,0,0,0.35);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 18px;
      z-index: 999;
    }
    .modalBack.on{ display:flex; }
    .modal{
      width: min(520px, 100%);
      background:#fff;
      border-radius: 14px;
      border: 1px solid rgba(0,0,0,0.08);
      overflow:hidden;
    }
    .modalHead{
      padding: 14px 16px;
      border-bottom: 1px solid var(--line);
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap:10px;
    }
    .modalTitle{
      font-size: 14px;
      font-weight: 700;
      letter-spacing:.08em;
      color: var(--muted);
      margin:0;
    }
    .modalBody{
      padding: 16px;
      text-align:center;
    }
    .charStage{
      margin-top: 6px;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
    }
    .navBtn{
      width:44px;
      min-width:44px;
      height:44px;
      padding:0;
      border-radius: 14px;
      font-size: 18px;
    }
    .charCard{
      width: min(320px, 100%);
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 12px 12px 14px;
      background: #fff;
    }
    .charName{
      font-weight: 800;
      letter-spacing:.08em;
      margin: 6px 0 8px;
    }
    .charDesc{
      color: var(--muted2);
      font-size: 12px;
      line-height: 1.7;
      letter-spacing:.04em;
      min-height: 3.4em;
    }
    .charPreview{
      width: 220px;
      height:auto;
      display:block;
      margin: 0 auto;
    }
    .modalFoot{
      border-top: 1px solid var(--line);
      padding: 12px;
      display:flex;
      gap:10px;
      justify-content:center;
      align-items:center;
      background:#fff;
    }

    /* フェード */
    .fadeLayer{
      position: fixed;
      inset: 0;
      background: #fff;
      opacity: 0;
      pointer-events: none;
      z-index: 1000;
      transition: opacity .30s ease;
    }
    .fadeLayer.on{ opacity: 1; pointer-events: auto; }

    @media (max-width: 420px){
      main{ min-height: 560px; }
      .game, .result{ min-height: 560px; }
      #charImg{ width: 220px; }
      #percentBig{ font-size: 64px; }
      .answers button{ min-height: 62px; }
    }
    @media (prefers-reduced-motion: reduce){
      #topImg, .tapHint{ animation:none!important; }
      .fadeLayer{ transition:none; }
    }
  </style>
</head>

<body>
  <div class="fadeLayer" id="fade"></div>

  <div class="wrap">
    <div class="card">
      <header>
        <div class="headLeft">
          <div class="dot"></div>
          <h1>デカブサ占い</h1>
        </div>
        <div id="quota">今日はあと∞回</div>
      </header>

      <main id="main">

        <!-- ===== TOP ===== -->
        <section id="screenTop" class="top">
          <div class="topTitle">あなたの運勢はどう？</div>
          <div class="topCopy">98%の人が
外れたと回答</div>
          <div class="tapHint">タップして</div>

          <div class="hero">
            <img id="topImg" src="dekabusa.png" alt="デカブサ">
          </div>

          <div class="miniNote">※当たったと思っても外れています</div>
        </section>

        <!-- ===== GAME ===== -->
        <section id="screenGame" class="game" style="display:none;">
          <div id="progress">1 / 7</div>
          <div id="question">読み込み中</div>

          <div class="spacer"></div>

          <div class="charBottom">
            <img id="charImg" src="" alt="キャラ">
          </div>

          <div class="answers" id="answers">
            <button type="button" data-a="0">当たった</button>
            <button type="button" data-a="1">外れた</button>
            <button type="button" data-a="2">知らん</button>
            <button type="button" data-a="3">気のせい</button>
          </div>
        </section>

        <!-- ===== RESULT ===== -->
        <section id="screenResult" class="result" style="display:none;">
          <div class="resultHead">
            <p class="resultTitle">あなたの運勢はどう？</p>
            <div class="resultSub">
              98%の人が<br>
              外れたと回答
            </div>

            <div id="percentBig">0%</div>
            <div style="margin-top:10px;color:#666;letter-spacing:.12em;font-size:12px;">今日の運勢</div>
            <div id="rankText"></div>
            <div id="resultLines"></div>
          </div>

          <div class="spacer"></div>

          <!-- 結果のキャラは“1体だけ”ここ -->
          <div class="charBottom" style="padding-bottom:0;">
            <img id="resultChar" src="" alt="キャラ（結果）" style="width:220px; height:auto; transition:opacity 0.15s;">
          </div>

          <div class="retryWrap">
            <button class="retryBtn" id="btnRetry" type="button">もう一度見る</button>
          </div>
        </section>

      </main>

      <!-- ===== FOOTER ===== -->
      <div class="footer" id="footerTop">
        <button id="btnStart" class="primary" type="button">START</button>
      </div>

    </div>
  </div>

  <!-- ===== 仲間紹介モーダル（必ず選択） ===== -->
  <div class="modalBack" id="modalBack" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-label="仲間紹介">
      <div class="modalHead">
        <p class="modalTitle">仲間紹介</p>
        <div style="font-size:12px;color:#9a9a9a;letter-spacing:.08em;">必ず選択</div>
      </div>

      <div class="modalBody">
        <div class="charStage">
          <button class="navBtn" id="btnPrev" type="button">‹</button>

          <div class="charCard">
            <img id="pickImg" class="charPreview" src="dekabusa.png" alt="">
            <div class="charName" id="pickName">デカブサ</div>
            <div class="charDesc" id="pickDesc">まあ…やるだけやれ。</div>
          </div>

          <button class="navBtn" id="btnNext" type="button">›</button>
        </div>

        <div class="miniNote">
          追加キャラは、表示と文言が変わるだけです。<br>
          やることは変わりません。
        </div>
      </div>

      <div class="modalFoot">
        <button id="btnChoose" class="primary" type="button">このキャラにする</button>
      </div>
    </div>
  </div>

  <script>
    // ========= 画面 =========
    const screenTop    = document.getElementById("screenTop");
    const screenGame   = document.getElementById("screenGame");
    const screenResult = document.getElementById("screenResult");
    const footerTop    = document.getElementById("footerTop");
    const fade         = document.getElementById("fade");

    // ========= 仲間（画像名をここで管理） =========
    // ★カンえもんは kanemon_1.png / kanemon_2.png
    const CHAR_LIST = [
      { id:"dekabusa", name:"デカブサ",   img1:"dekabusa.png",  img2:null,             desc:"まあ…やるだけやれ。" },
      { id:"lion",     name:"ライオン丸", img1:"lionmaru.png",  img2:null,             desc:"……黙って見ろ。" },
      { id:"namaken",  name:"ナマケン",   img1:"namaken.png",   img2:null,             desc:"…うん…まあ…" },
      { id:"tora",     name:"とらさん",   img1:"torasan.png",   img2:null,             desc:"よし。次いくか。" },
      { id:"kane",     name:"カンえもん", img1:"kanemon_1.png", img2:"kanemon_2.png",  desc:"（入ってる）三次元だ。" },
    ];

    // ========= 質問プール（脱力寄り） =========
    const Q = [
      "今日は様子見したい？",
      "深く考えたくない？",
      "とりあえず寝たい？",
      "早く帰りたい？",
      "今はその時じゃないと思う？",
      "気にするだけ損だと思う？",
      "今日は静かに過ごしたい？",
      "何もしない日も価値があると思う？",
      "急ぐ必要はないと思う？",
      "なんとかなると思う？",
      "今日は面倒を避けたい？",
      "動くより止まる方が楽？",
      "結局、気のせいだと思う？"
    ];

    function pick7(){
      const copy = [...Q];
      const out = [];
      while(out.length < 7 && copy.length){
        const j = Math.floor(Math.random()*copy.length);
        out.push(copy.splice(j,1)[0]);
      }
      return out;
    }

    // ========= 結果（確定） =========
    function getRank(p){
      if(p <= 19) return "絶不調";
      if(p <= 39) return "低調";
      if(p <= 59) return "普通";
      if(p <= 79) return "好調";
      return "絶好調";
    }
    const RESULT_LINES = {
      "絶不調": ["今日は運勢が良くない。", "どうせ外れるから気にするな。"],
      "低調":   ["今日は少し流れが悪い。", "まあ、そんな日もある。"],
      "普通":   ["今日は普通。", "特別ではないが問題もない。"],
      "好調":   ["今日は悪くない。", "少しだけ動いてもいいかもしれない。"],
      "絶好調": ["今日はかなり良い流れ。", "珍しい日だ。"]
    };

    // ========= DOM =========
    const btnStart   = document.getElementById("btnStart");
    const mainEl     = document.getElementById("main");

    const progressEl = document.getElementById("progress");
    const questionEl = document.getElementById("question");
    const charImg    = document.getElementById("charImg");
    const answersEl  = document.getElementById("answers");

    const percentBig = document.getElementById("percentBig");
    const rankText   = document.getElementById("rankText");
    const resultLines= document.getElementById("resultLines");
    const resultChar = document.getElementById("resultChar");
    const btnRetry   = document.getElementById("btnRetry");

    // ========= モーダル =========
    const modalBack  = document.getElementById("modalBack");
    const btnPrev    = document.getElementById("btnPrev");
    const btnNext    = document.getElementById("btnNext");
    const btnChoose  = document.getElementById("btnChoose");
    const pickImg    = document.getElementById("pickImg");
    const pickName   = document.getElementById("pickName");
    const pickDesc   = document.getElementById("pickDesc");
    let pickIndex = 0;

    function openModal(){
      pickIndex = 0;
      renderPick();
      modalBack.classList.add("on");
      modalBack.setAttribute("aria-hidden","false");
    }
    function closeModal(){
      modalBack.classList.remove("on");
      modalBack.setAttribute("aria-hidden","true");
    }
    function renderPick(){
      const c = CHAR_LIST[pickIndex];
      pickImg.src = c.img1;
      pickImg.alt = c.name;
      pickName.textContent = c.name;
      pickDesc.textContent = c.desc;
    }

    btnPrev.addEventListener("click", (e)=>{
      e.stopPropagation();
      pickIndex = (pickIndex - 1 + CHAR_LIST.length) % CHAR_LIST.length;
      renderPick();
    });
    btnNext.addEventListener("click", (e)=>{
      e.stopPropagation();
      pickIndex = (pickIndex + 1) % CHAR_LIST.length;
      renderPick();
    });
    modalBack.addEventListener("click", (e)=>{ e.stopPropagation(); }); // 外クリックで閉じない

    // ========= 画面切替 =========
    function showTop(){
      screenTop.style.display = "";
      screenGame.style.display = "none";
      screenResult.style.display = "none";
      footerTop.style.display = "";
    }
    function showGame(){
      screenTop.style.display = "none";
      screenGame.style.display = "";
      screenResult.style.display = "none";
      footerTop.style.display = "none";
    }
    function showResult(){
      screenTop.style.display = "none";
      screenGame.style.display = "none";
      screenResult.style.display = "";
      footerTop.style.display = "none";
    }

    // ========= ゲーム状態 =========
    let selectedChar = null;
    let questions = [];
    let idx = 0;
    let results = [];

    function renderQuestion(){
      progressEl.textContent = `${idx+1} / 7`;
      questionEl.textContent = questions[idx];

      // 質問中は“下にキャラ1体だけ”
      charImg.style.opacity = 1;
      charImg.src = selectedChar.img1;
    }

    function waitMs(ms){ return new Promise(r=>setTimeout(r, ms)); }

    // 4択は遊び心、結果は同じ（%はランダム加算）
    async function onAnswer(){
      // 各問：%は完全ランダム（内部だけ）
      const v = Math.floor(Math.random() * 101);
      results.push(v);

      // ちょい間を置いて次へ（連打防止）
      answersEl.classList.add("locked");
      await waitMs(220);
      answersEl.classList.remove("locked");

      idx++;
      if(idx >= 7){
        await finish();
      }else{
        renderQuestion();
      }
    }

    // 選択肢クリック
    answersEl.addEventListener("click", (e)=>{
      const btn = e.target.closest("button");
      if(!btn) return;
      onAnswer();
    });

    // ========= 結果：%カウント → “静→動→静→動→静” =========
    function countUpPercent(el, target, durationMs){
      return new Promise((resolve) => {
        const start = performance.now();
        const to = Math.max(0, Math.min(100, Math.floor(target)));
        function tick(now){
          const t = Math.min(1, (now - start) / durationMs);
          const eased = 1 - Math.pow(1 - t, 3);
          const v = Math.round(to * eased);
          el.textContent = `${v}%`;
          if(t < 1) requestAnimationFrame(tick);
          else resolve();
        }
        requestAnimationFrame(tick);
      });
    }

    async function playSequenceOnResultChar(){
      // カンえもんだけ 1/2 でコマ送り（指定どおり）
      if(selectedChar.id !== "kane" || !selectedChar.img2){
        resultChar.src = selectedChar.img1;
        resultChar.style.opacity = 1;
        return;
      }
      const sequence = [
        selectedChar.img1,
        selectedChar.img2,
        selectedChar.img1,
        selectedChar.img2,
        selectedChar.img1
      ];
      let i = 0;

      // 少し遅れて開始（あなたのコードそのまま）
      await waitMs(500);

      while(i < sequence.length){
        resultChar.style.opacity = 0;
        await waitMs(150);
        resultChar.src = sequence[i];
        resultChar.style.opacity = 1;
        i++;
        await waitMs(350);
      }
    }

    async function finish(){
      // 結果画面へ
      showResult();

      // 結果キャラ：ここに1体だけ
      resultChar.src = selectedChar.img1;
      resultChar.style.opacity = 1;

      // %計算
      const avg = Math.floor(results.reduce((a,b)=>a+b,0) / results.length);

      percentBig.textContent = "0%";
      rankText.textContent = "";
      resultLines.textContent = "";

      await countUpPercent(percentBig, avg, 950);

      const rank = getRank(avg);
      rankText.textContent = rank;
      const lines = RESULT_LINES[rank] || ["今日はそんな日。","気にするな。"];
      resultLines.textContent = lines.join("\n");

      // コマ送り（カンえもんだけ）
      await playSequenceOnResultChar();
    }

    // ========= STARTフロー（必ずキャラ選択） =========
    function goStartFlow(){
      fade.classList.add("on");
      setTimeout(()=>{
        fade.classList.remove("on");
        openModal();
      }, 220);
    }
    btnStart.addEventListener("click", (e)=>{ e.stopPropagation(); goStartFlow(); });
    screenTop.addEventListener("click", ()=>{ goStartFlow(); }, { passive:true });

    btnChoose.addEventListener("click", async (e)=>{
      e.stopPropagation();
      selectedChar = CHAR_LIST[pickIndex];
      localStorage.setItem("selectedCharacter", selectedChar.id);

      closeModal();

      // 準備
      questions = pick7();
      idx = 0;
      results = [];

      fade.classList.add("on");
      setTimeout(()=>{
        fade.classList.remove("on");
        showGame();
        renderQuestion();
      }, 220);
    });

    // ========= もう一度見る =========
    btnRetry.addEventListener("click", ()=>{
      // トップへ戻す（シンプルに）
      showTop();
    });

    // ========= 起動 =========
    showTop();
  </script>
</body>
</html>
