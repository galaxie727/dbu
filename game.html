<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>デカブサ占い</title>

<style>
:root{
  --bg:#f7f7f7;
  --card:#ffffff;
  --line:#e6e6e6;
  --text:#111;
  --muted:#666;
  --accent:#ffd400;

  --footer-h: 140px;
  --deka-w: 260px;
  --deka-gap: 14px;
  --text-top-pad: 26px;
}

*{ box-sizing:border-box; }
body{
  margin:0;
  font-family: system-ui, -apple-system, "Hiragino Kaku Gothic ProN",
               "Noto Sans JP", "Yu Gothic", sans-serif;
  background: var(--bg);
  color: var(--text);
}
.wrap{
  min-height: 100svh;
  display:flex;
  align-items:center;
  justify-content:center;
  padding: 18px;
}
.card{
  width: min(680px, 100%);
  background: var(--card);
  border: 1px solid var(--line);
  border-radius: 14px;
  overflow:hidden;
  position: relative;
}
header{
  padding: 14px 16px;
  border-bottom: 1px solid var(--line);
  display:flex;
  align-items:center;
  justify-content: space-between;
  gap:10px;
}
.headLeft{
  display:flex;
  align-items:center;
  gap:10px;
  min-width: 0;
}
.dot{
  width:10px; height:10px;
  border-radius:50%;
  background: var(--accent);
  flex: 0 0 auto;
}
h1{
  font-size:14px;
  font-weight:700;
  margin:0;
  letter-spacing:.08em;
  color:var(--muted);
  white-space: nowrap;
}
#quota{
  font-size: 12px;
  color: #9a9a9a;
  letter-spacing: .08em;
  white-space: nowrap;
}
main{
  padding: var(--text-top-pad) 18px calc(var(--footer-h) + 18px);
  text-align:center;
  min-height: 520px;
  position: relative;
}
#text{
  white-space: pre-line;
  font-size: clamp(28px, 4.6vw, 36px);
  line-height: 1.55;
  letter-spacing: .06em;
  margin: 0;
  text-align: center;
}
#sub{
  margin: 20px 0 0;
  font-size: 14px;
  color: #9a9a9a;
  letter-spacing: .08em;
  min-height: 1.6em;
  white-space: nowrap;
  text-align: center;
  line-height: 1.9;
}
.blink{ animation: blinkFade 1.2s ease-in-out infinite; }
@keyframes blinkFade{
  0%,100%{ opacity: 0.25; }
  50%    { opacity: 1; }
}

footer{
  border-top: 1px solid var(--line);
  height: var(--footer-h);
  display:grid;
  grid-template-columns: 1fr 1fr;
  gap:12px;
  justify-content:center;
  align-items:center;
  padding: 14px;
}
button{
  appearance:none;
  border:1px solid var(--line);
  background:#fafafa;
  color:#111;
  border-radius: 18px;
  padding:16px 10px;
  font-size:16px;
  cursor:pointer;
  transition: opacity .15s ease;
}
button:active{
  transform: translateY(1px);
  background:#f2f2f2;
}
footer.locked button{
  opacity: .35;
  cursor: default;
  pointer-events: none;
}

.character{
  position:absolute;
  right: var(--deka-gap);
  bottom: var(--footer-h);
  width: var(--deka-w);
  height: auto;
  opacity: .98;
  pointer-events:none;
  user-select:none;
}

.dim{
  position:absolute;
  inset:0;
  background: rgba(0,0,0,0.22);
  opacity:0;
  pointer-events:none;
  transition: opacity .2s ease;
}
.dim.show{ opacity:1; }
</style>
</head>

<body>
<div class="wrap">
  <div class="card">
    <header>
      <div class="headLeft">
        <div class="dot"></div>
        <h1>デカブサ占い</h1>
      </div>
      <div id="quota"></div>
    </header>

    <main id="main">
      <p id="text">読み込み中</p>
      <p id="sub"></p>
    </main>

    <footer id="choices" class="locked"></footer>

    <img id="charaImg" class="character" src="dekabusa_1.png" alt="character">
    <div id="dim" class="dim"></div>

    <audio id="clap" src="clap.mp3" preload="auto"></audio>
  </div>
</div>

<script>
/* ===== debug (?debug=1) ===== */
const params = new URLSearchParams(location.search);
const IS_DEBUG = params.get("debug") === "1";

/* ===== daily limit ===== */
const DAILY_LIMIT = 3;
const KEY_DATE="dekabusa_date";
const KEY_COUNT="dekabusa_count";

function todayKey(){ return new Date().toLocaleDateString("ja-JP"); }
function loadCount(){
  const t = todayKey();
  const d = localStorage.getItem(KEY_DATE);
  if(d !== t){
    localStorage.setItem(KEY_DATE, t);
    localStorage.setItem(KEY_COUNT, "0");
  }
  const c = parseInt(localStorage.getItem(KEY_COUNT) || "0", 10);
  return isNaN(c) ? 0 : c;
}
function remainCount(){
  if(IS_DEBUG) return DAILY_LIMIT;
  const c = loadCount();
  return Math.max(0, DAILY_LIMIT - Math.min(c, DAILY_LIMIT));
}
function consumeOnce(){
  if(IS_DEBUG) return true;
  const c = loadCount();
  if(c >= DAILY_LIMIT) return false;
  localStorage.setItem(KEY_COUNT, String(c + 1));
  return true;
}
function updateQuota(){
  const r = remainCount();
  quota.textContent = (r <= 0) ? "今日はもう終わりです" : `今日はあと${r}回`;
}

/* ===== intro ===== */
function pickIntro(){
  const rare = Math.random() < 0.05;
  return rare
    ? "あなたの運勢はどう？\n\n2%の人が\n当たったと解答"
    : "あなたの運勢はどう？\n\n98%の人が\n外れたと解答";
}

/* ===== questions (デカブサ世界っぽく) ===== */
const QUESTIONS = [
  { q:"朝。\n最初にすることは？", a:["とりあえず起きる","起きた体にする","まだ夜の続き","今じゃない"] },
  { q:"やることが増えた。\nどうする？", a:["一個だけやる","検討はした","永久に保留","見なかった"] },
  { q:"予定に誘われた。\n返事は？", a:["行けたら行く","あとで返す","既読のまま","気配を消す"] },
  { q:"財布が軽い。\n気分は？", a:["節約する","気にしない","見ない","増えない"] },
  { q:"作業が重い。\n手は動く？", a:["動く","半分だけ動く","動かない","やってる感"] },
  { q:"外がうるさい。\n対処は？", a:["耐える","耳栓","逃げる","心を無にする"] },
  { q:"最後に。\n今日の方針は？", a:["無理しない","普通","無","今日はそういう日"] },
];
const SCORE = [
  [2,1,0,0],
  [2,1,0,0],
  [2,1,0,0],
  [1,1,0,0],
  [2,1,0,0],
  [1,1,0,0],
  [0,0,0,0],
];

/* ===== characters (2コマ) =====
   frames: [1,2]
*/
const CHAR = {
  dekabusa: { frames:["dekabusa_1.png","dekabusa_2.png"], say:["まあ、そうだな","無理すんな","続けよう","今はそれでいい","だいたいそんなもんだ"] },
  namaken:  { frames:["namaken_1.png","namaken_2.png"],   say:["あとでいい","急ぐな","寝てもいい","そのうち","まあ…"] },
  kanemon:  { frames:["kanemon_1.png","kanemon_2.png"],   say:["まあ入る","持っとくか","使わないかも","入れとく","とりあえず"] },
  lion:     { frames:["lionmaru_1.png","lionmaru_2.png"], special:true },
};

/* 出現率：デカ75 / ナマ10 / カン10 / ライオン5 */
function pickSpeaker(){
  const r = Math.random() * 100;
  if(r < 75) return "dekabusa";
  if(r < 85) return "namaken";
  if(r < 95) return "kanemon";
  return "lion";
}

/* ===== DOM ===== */
const mainEl = document.getElementById("main");
const text = document.getElementById("text");
const sub  = document.getElementById("sub");
const footer = document.getElementById("choices");
const quota = document.getElementById("quota");
const charaImg = document.getElementById("charaImg");
const dim = document.getElementById("dim");
const clap = document.getElementById("clap");

/* ===== 2コマアニメ制御 ===== */
let currentChar = "dekabusa";
let frameIdx = 0;
let animTimer = null;

function stopAnim(){
  if(animTimer){
    clearInterval(animTimer);
    animTimer = null;
  }
}
function setChar(name, forceFrame0=true){
  currentChar = name;
  stopAnim();
  if(forceFrame0) frameIdx = 0;
  charaImg.src = CHAR[name].frames[frameIdx];
}
function startTalkAnim(name, intervalMs=180){
  // セリフ中だけパタパタ
  stopAnim();
  currentChar = name;
  // 今のフレームから開始
  animTimer = setInterval(() => {
    frameIdx = 1 - frameIdx;
    charaImg.src = CHAR[name].frames[frameIdx];
  }, intervalMs);
}

/* ===== state ===== */
let mode = "intro"; // intro | q | result | limit | lion_wait
let idx = -1;
let score = 0;

function lockChoices(locked){
  if(locked) footer.classList.add("locked");
  else footer.classList.remove("locked");
}

/* ===== screens ===== */
function showLimit(){
  mode = "limit";
  lockChoices(true);
  dim.classList.remove("show");
  setChar("dekabusa", true);
  text.textContent = "今日は\nもうこれくらいです\n\nまた明日";
  sub.classList.remove("blink");
  sub.textContent = "";
  updateQuota();
}

function showIntro(){
  updateQuota();
  if(!IS_DEBUG && remainCount() <= 0){
    showLimit();
    return;
  }
  mode = "intro";
  idx = -1;
  score = 0;
  dim.classList.remove("show");
  setChar("dekabusa", true);

  text.textContent = pickIntro();
  sub.classList.add("blink");
  sub.textContent = "タップして";
  footer.innerHTML = "";
  lockChoices(true);
}

function renderQuestion(){
  mode = "q";
  dim.classList.remove("show");

  const q = QUESTIONS[idx];
  text.textContent = q.q;
  sub.classList.remove("blink");
  sub.textContent = `${idx+1} / ${QUESTIONS.length}`;

  footer.innerHTML = "";
  lockChoices(false);

  q.a.forEach((label, optIndex) => {
    const b = document.createElement("button");
    b.type = "button";
    b.textContent = label;
    b.onclick = () => onAnswer(optIndex);
    footer.appendChild(b);
  });
}

function nextQuestion(){
  idx++;
  if(idx >= QUESTIONS.length){
    showResult();
    return;
  }
  // 次の問題は “今居るキャラのまま” 表示（居座り仕様）
  renderQuestion();
}

function showSpeakerLine(charName){
  lockChoices(true);

  if(charName === "lion"){
    // ライオン丸：特別演出 → 自動で進まない（タップで進む）
    mode = "lion_wait";
    dim.classList.add("show");
    setChar("lion", true);
    startTalkAnim("lion", 220); // ちょいゆっくり目で“重い感じ”

    text.textContent = "ザ・トーマレ！";
    sub.classList.remove("blink");
    sub.textContent = "";

    setTimeout(() => {
      text.textContent = "ザ・トーマレ！\n時を止めてから拍手";
      try{
        const p = clap.play();
        if(p && typeof p.catch === "function") p.catch(()=>{});
      }catch(e){}
      stopAnim(); // ここで静止（時が止まった感じ）
      sub.classList.add("blink");
      sub.textContent = "タップして続ける";
    }, 400);

    return;
  }

  // 通常キャラ：一言中だけ2コマで口パク → 次へ（キャラは居座る）
  setChar(charName, true);
  startTalkAnim(charName, 160);

  const lines = CHAR[charName].say;
  text.textContent = lines[Math.floor(Math.random() * lines.length)];
  sub.classList.remove("blink");
  sub.textContent = "";

  setTimeout(() => {
    stopAnim();
    // “居座り”なので最後のフレームのまま残す（=少し表情変化が残る）
    nextQuestion();
  }, 720);
}

function onAnswer(optIndex){
  if(SCORE[idx] && typeof SCORE[idx][optIndex] === "number"){
    score += SCORE[idx][optIndex];
  }
  const speaker = pickSpeaker();
  showSpeakerLine(speaker);
}

function showResult(){
  if(!consumeOnce()){
    showLimit();
    return;
  }
  updateQuota();
  mode = "result";
  lockChoices(true);
  dim.classList.remove("show");

  // 結果画面は必ずデカブサ
  setChar("dekabusa", true);

  let result;
  if(score >= 9) result = "今日は\n割と動ける\n\nでも無理はするな";
  else if(score >= 5) result = "今日は\n普通\n\nだいたい普通";
  else result = "今日は\n無\n\nやらなくていい";

  text.textContent = result;
  sub.classList.remove("blink");
  sub.textContent = "今日は、そういう日だ";
}

/* ===== tap behavior ===== */
mainEl.addEventListener("click", () => {
  if(mode === "intro"){
    if(!IS_DEBUG && remainCount() <= 0){
      showLimit();
      return;
    }
    sub.classList.remove("blink");
    nextQuestion();
    return;
  }

  if(mode === "lion_wait"){
    // タップで続ける：暗転解除→デカブサへ戻す→次の質問
    dim.classList.remove("show");
    sub.classList.remove("blink");
    sub.textContent = "";
    stopAnim();
    setChar("dekabusa", true);
    nextQuestion();
    return;
  }
});

/* ===== start ===== */
updateQuota();
showIntro();
</script>
</body>
</html>
